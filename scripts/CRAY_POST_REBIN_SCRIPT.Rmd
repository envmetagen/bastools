---
title: "Processing a taxatable post MBC and illumina_post_MBC_script2.R"
html_notebook: default
subtitle: ''
classoption: portrait
output: html_document

---

# CRAY COI

## read settings
```{r, eval=TRUE, results='hide',echo=F}
source("/home/bastian.egeter/git_bastools/bastools/examples/example_POST_REBIN_SCRIPT.config.R")
```


```{r, eval=TRUE, results='hide',echo=F}
setwd(bastoolsDir)
source("master_functions.R")
library(ggplot2)
library(googlesheets4)
library(dplyr)
library(stringr)
options(httr_oob_default = TRUE)
```

## organise mastersheet
```{r, eval=TRUE,echo=F}
master_sheet<-google.read.master.url(ss_url)
#remove duplicate columns (should functionise this)
master_sheet<-remove.google.dups(master_sheet)

#changing sample_type too to match functions
master_sheet<-fix.google.colnames(master_sheet)

#check on number of samples in each category
message("Showing xtabs for entire datasheet, including Sample_Type by default")
master_xtabs(master_sheet,columns=c(names(subsetlist)))
colnames(master_sheet)
##subset master sheet for this study 
message("Subsetting datasheet")
ms_ss<-subset_mastersheet(master_sheet, subsetlist)
#check again to see the subset made sense
master_xtabs(ms_ss,columns=c(names(subsetlist)))

```

# Make counts at various steps of MBC and illumina script
```{r, eval=TRUE,echo=F}
#countdf<-count.MBC(MBCtsvDir,ms_ss,otutab,illumina_script_taxatab,illumina_script_taxatab_tf)
```

## import taxatabs
```{r, eval=TRUE,echo=F, results='hide'}
#import taxtabs
all.taxatabs<-bas.merge.taxatabs(taxatabs)

#make new taxa table based on subsetted master sheet
all.taxatabs.ss<-cbind(taxon=all.taxatabs$taxon,all.taxatabs[colnames(all.taxatabs) %in% ms_ss$ss_sample_id])
```

## remove samples/taxa with 0 reads
```{r, eval=TRUE,echo=F}
all.taxatabs.ss<-rm.0readtaxSam(all.taxatabs.ss)
```

## summary ---this is pre-grouping - please inspect, add groupings to config file as necessary and look at post-grouping table. Can more grouping be done, is anything wrong?
```{r, eval=TRUE,echo=F}
DT::datatable(summary.dxns.by.taxon(all.taxatabs.ss), rownames = FALSE, options = list(pageLength = 100, scrollX=T))
```

## group taxa, where possible
```{r, eval=TRUE}
for(i in 1:nrow(taxa.to.group)){
  all.taxatabs.ss<-bas.group.taxa(taxatab = all.taxatabs.ss,taxon=as.character(taxa.to.group[i,1]), jointo=as.character(taxa.to.group[i,2]))
}
```

## summary--post-grouping
```{r, eval=TRUE,echo=F}
DT::datatable(summary.dxns.by.taxon(all.taxatabs.ss), rownames = FALSE, options = list(pageLength = 100, scrollX=T))
```

## apply taxon and sample filters
```{r, eval=TRUE,echo=F}
#Filter samples before removing the NAs and no_hits (0.1%)
all.taxatabs.ss<-taxon.filter.solo.df(taxatab = all.taxatabs.ss,taxonpc = taxonpc)
all.taxatabs.ss<-sample.filter.solo(taxatab = all.taxatabs.ss,samplepc=samplepc)
```

## remove the NAs and no_hits
```{r, eval=TRUE,echo=F}
message("Removing NAs and no_hits")
all.taxatabs.ss<-all.taxatabs.ss[all.taxatabs.ss$taxon!="NA;NA;NA;NA;NA;NA;NA",]
all.taxatabs.ss<-all.taxatabs.ss[all.taxatabs.ss$taxon!="no_hits;no_hits;no_hits;no_hits;no_hits;no_hits;no_hits",]
#countdf$'After project taxon and sample filter'<-sum(all.taxatabs.ss[,-1])
```

## apply detection filter
```{r, eval=TRUE,echo=F}
#check with removing detections
message("Applying detection filter")
all.taxatabs.ss.joined.dxn<-filter.dxns(taxatab = all.taxatabs.ss,filter_dxn = filter_dxn)
```

## check negatives and save results
```{r, eval=TRUE,echo=F}
message("Checking negs")
negatives<-negs.stats(taxatab=all.taxatabs.ss.joined.dxn,ms_ss = ms_ss,real=real,ex_hominidae=F)
```

## remove contaminants from relevant groups
```{r, eval=TRUE,echo=F}
message("Applying contaminant filter")
all.taxatabs.ss.joined.dxn.rmcons<-remove.contaminant.taxa(taxatab = all.taxatabs.ss.joined.dxn,master_sheet = ms_ss,negatives = negatives,group.codes = c("Sample_Plate","Sample_Well"))
#groups must be in the corresponding order to the object 'negatives' 

#check negatives again, just to be sure
negatives<-negs.stats(taxatab=all.taxatabs.ss.joined.dxn.rmcons,ms_ss = ms_ss,real=real,ex_hominidae=F)
```

## aggregate at chosen level and keep only that-level taxa 
```{r, eval=TRUE,echo=F}
all.taxatabs.ss.joined.dxn.rmcons.xlev<-aggregate.at.xLevel(taxatab=all.taxatabs.ss.joined.dxn.rmcons,xLevel = xLevel)

all.taxatabs.ss.joined.dxn.rmcons.xlev<-keep.below.xLevel.assigns(taxatab = all.taxatabs.ss.joined.dxn.rmcons,xLevel = xLevel)
```
## remove detection in less than 2 reps (order for this?)
```{r, eval=TRUE,echo=F}
all.taxatabs.ss.joined.dxn.rmcons.xlev.rmsingdxns<-rm.single.rep.detections(all.taxatabs.ss.joined.dxn.rmcons.xlev,ms_ss = ms_ss,grouping = rep.rm)
```

## sum reps
```{r, eval=TRUE,echo=F}
all.taxatabs.ss.joined.dxn.rmcons.xlev.rmsingdxns<-sumreps(all.taxatabs.ss.joined.dxn.rmcons.xlev.rmsingdxns,master_sheet = ms_ss,by = sumrepsby)
```                                                        
                                                           ```

## summary 
```{r, eval=TRUE,echo=F}
#summary
DT::datatable(summary.dxns.by.taxon(all.taxatabs.ss.joined.dxn.rmcons.xlev), rownames = FALSE, 
                        options = list(pageLength = 100, scrollX=T))
```

## some barplots
```{r, eval=TRUE,echo=F}
plotlist<-list()
for(i in 1:length(stackplot.vars)){
plotlist[[i]]<-taxatab.stackplot(all.taxatabs.ss.joined.dxn.rmcons.xlev,master_sheet = ms_ss,column = stackplot.vars[i],as.percent = F,as.dxns = T,hidelegend = T)
print(plotlist[[1]][[1]])
print(plotlist[[1]][[2]])
}

for(i in 1:length(stackplot.vars)){
plotlist[[i]]<-taxatab.stackplot(all.taxatabs.ss.joined.dxn.rmcons.xlev,master_sheet = ms_ss,column = stackplot.vars[i],as.percent = T,as.dxns = F,hidelegend = T)
print(plotlist[[1]][[1]])
print(plotlist[[1]][[2]])
}

for(i in 1:length(stackplot.vars)){
plotlist[[i]]<-taxatab.stackplot(all.taxatabs.ss.joined.dxn.rmcons.xlev,master_sheet = ms_ss,column = stackplot.vars[i],as.percent = F,as.dxns = F,hidelegend = T)
print(plotlist[[1]][[1]])
print(plotlist[[1]][[2]])
}

```


## pca plot (just an example, not interesting in this case)
```{r, eval=TRUE,echo=F}
#just an example, not interesting in this case
p<-taxatab.pca.plot.col(taxatab = all.taxatabs.ss.joined.dxn.rmcons.xlev,master_sheet = ms_ss,MS_colID = "ss_sample_id",lines = T,longnames = F,shortnames = T,ellipse = T,factor1 = "predator")
p
```

## plot counts
```{r, eval=TRUE,echo=F}
# long<-as.data.frame(t(countdf))
# long$step<-rownames(long)
# long$step<-factor(long$step,levels=long$step)
# colnames(long)[1]<-"reads"
# p<-ggplot(long,aes(x=step,y=reads,label = long$reads))+geom_bar(stat = "identity") +
#    theme(axis.text.x = element_text(angle = 45,hjust=1))+
#    theme(axis.line = element_line(colour = "black"))+
#    theme(panel.background = element_blank())+
#    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
#   scale_y_continuous(labels = scales::comma)
# p

#save plot, outside of rmd
# ggplot2::ggsave(filename = "read.counts.plot.tiff",p,device = "tiff",dpi = "print",)

```

## write final table
```{r, eval=TRUE,echo=F}
#write.table(all.taxatabs.ss.joined.dxn.rmcons.spL,"all.taxatabs.ss.joined.dxn.rmcons.spL.12S1.txt",quote = F, row.names = F,col.names = T,sep = "\t")
```